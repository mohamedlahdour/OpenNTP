! THiS PROGRAM REQUIRES SUBROUTINES TOT#ALCKZFISSCATCON2,INOUT7,
! R0D9 AND INOUT8
! 2-Di S4 CALCULATION USING CARLSON'S MU(M)-BARS, FOR 40 X 40 MESH
 REAL, DIMENSION FS(2,3),FCS(3), S(13,6), ST(13,3),P(40,40,3),ISUM(8,16),V(3),
                 SX(40,40,3),SCC(6),PBX(40,41),PBY(41,40),X(3),P4(40,2,40),P5(40,40),
                 DX(40),DY(40),F1(40),F2(40),F3(40),F4(40),F5(40),F63(40),BXCX(12)
 REAL, DIMENSION QC(6),QF(6),QF1(3),QF2(3),QC2(3)
! READ CROSS-SECTIONS9 INCREMENTS9 VALUES OF NU
! INCREMENTS IN THE X-DIRECTICN
  READ(5,105) (DX(I),I=1,40)
! INCREMENTS IN THE Y-DIRECTION
! EVERY OTHER lNCREMENT IS READ, EQUAL TO THE
! QUANTITY (DY(i)+DY(I+13)*THESE ARE THEN DIVIDED BY
! TWO AND STORED APPROPRIATELY. IF UNEQUAL SPACING
! IS DESIRED9 THIS MAY BE CHANGED TO READ &EACH
! OF THE 40 INCREMENTS.
  READ(5,105) (DY(I) , I=1,39,2)
  DO I=2,40,2
     DY( I-1)=DY( I-1 )/2
     DY(I)=DY(I-1)
  ENDDO
! FISSION CROSS-SECTIONS
! FS(1,K) CONTAINS ROD FUEL FISSION CROSS-SECTIONS.
! FS(2,K) CONTAINS FIXED FUEL RS-ETOS
  READ(5,106) ((FS(M,K),K=1,3),M=1,2)
! VALUES OF NU
  READ(5,106) (V(I) ,I=1,3)
! VALUES OF CHI
  READ(5,106) (X(I),I=1,3)
! CONVERGENCE CRITERION (EPSILON).
  READ(5,106) AAA
! GROUP TO GROUP SCATTERING CROSS-SECTIONS
  READ(5,105) ((S(M,N), N=1,6),M=1,13)
! TOTAL CROSS-SECTIONS
  READ(5,106)((ST(MK),K=1,3),M=1,13)
! INITIALIZE THE FLUX
! L IS THE NUMBER OF THE UNIT ON-WHICH THE
! INITIAL FLUX IS WRITTEN.
  READ(5,99) L
  NUM=0
  READ(5,120)(BXCX(I),I=1,12)
  WRITE(6,119)(CBXCX(I),I=1,12)
  READ (L) II,IJ,IK,( ( (P(I,J,K),I=1,II) ,J=1,J),K=1,IK)
  REWIND L
  DATA NSC,VU,VC/0.1,0./
! D82 1S THE PSEUDO-ABSORPTION CROSS-SECTION TO
! ALLOW FOR VERTICAL LEAKAGE.
  DATA NTP,NN,NT,KTR,PI,DB2/4*0,0.01745329,0.047752/
  DO N=I,6
     QC(N)=S(5,N)
     QF(N)=S(9,N)
  ENDDO
  DO K=1,3
     OF1(K)=FS( 1K)
     QF2(K)=ST(9tK)
     QC2(K)=ST(5,K)
  ENDDO
! SET THE THERMAL FLUX IN THE CENTER OF THE CADMIUM
! CURTAIN TO ZERO.
  DO J=1,19
     P(12,J,3)=.0
     P(13,J,3)=.0
  ENDDO
! CALCULATE SOURCE TERMS
5 SCE=0.
  NTP=NTP+1
  NN=NN+1
! CALCULATE THE TOTAL FISSION SOURCE
  DO 2 J=1,16
  DO 2 I=1,8
  CALL FIS(I,J,FS,FCS)
  SUM(I,J)=0.
  DO 3 K=1,3
     SUM(I,J)=SUM(I,J)+V(K)*FCS(K)*P(I,J,K)
2    SCE=SCE+SUM(I,J)*DX(I)*DY(J)
    IF(KTR)35,35,6
! NORMALIZE THE FISSION SOURCE
35 DO I=1,8
  DO J=1,16
  SUM(I,J)=SUM(I,J)/SCE
  ENDDO
  ENDDO
! NORMALIZE THE FLUX.
  DO K=1,3
  DO I=1,40
  DO J=1,40
     P(I,J,K)=P(I,J,K)/SCE
  ENDDO
  ENDDO
  ENDDO
! STORE THE EIGENVALUE LAMBDA
  SI=SCE
!CALCULATE THE SCATTERING. SOURCE
  DO J=1,40
  DO I=1,40
  CALL SCAT(S,SCC,I,J)
  DO K=1,3
     SX(I,J,K)=0.
  DO KU=1,K
     N=KU+K-(1/KU)
     SX(I,J,K)=P(I,J,KU)*SCC(N)+SX(I,J,K)
  ENDDO
  ENDDO
  ENDDO
  ENDDO
! CALCULATE THE TOTAL SOURCE IN THE CORE FOR EACH CELL.
  DO K=1,3
  DO J=1,16
  DO I=1,8
     SX(I,J,K)=SX(I,J,K)+X(K)*SUM(I,J)
  ENDDO
  ENDDO
  ENDDO
! BEGIN INNER ITERATIONS
  DO 32 K=193
! SET BOUNDARY CONDITIONS AT ZERO
DO 7 1=1,40
  PBX( 1,41 )0.
7
PBY(41*I)=Oo
C
L IS THE INDEX FOR THE AZIMUTHAL ANGLE PHI
L=9
DO 45 JD=1940
J=4 1-JD
DO 45IrD=lt4O
1=41-ID
C
THE TOTAL CROSS-SECTIONS FOR THE POINT(IJ) ARE DENOTED BY TOT(K)
CALL TOTAL(I*JtKgSTtTOT)
CALL CON2(ABCLDX(I),DY(J),DB2tTOT)
PBY( I J)=SX( I ,JtK-A*PBY( I+1,J)
PBY( IJ)=PBY( 1,J)-C*PBX( IJ+1) )/B
P4(1,J)=(PBY(1,J)4-PBY(1+1,J))/2-.
45
PBX(1,J)=2**P4(IJ)-PBX(IJ+1)
C
SET ANY NEGATIVE FLUX TO ZERO.
DO 1000 Iz;1940
DO 1000 J=1940
IF(P4(1I J) )10019100091000
1001 P4(19J)=Oo
1000 CONI INUE
C
THE MATRICES F ARE USED TO STORE THOSE ANGULAR
C
FLUXES REFLECTED ACROSS A LINE OF SYMMETRY INTO
C
ANOTHER ANGLE.
DO 49 1=1,40
F3(1I)=PBY( 1;1)
49
F2(I)=PBX(I,1)
C
PBX(I,1) FOR L=9 IS PBX(Is1) FOR L=8
c
PBYI9J) FOR L=9 IS PBY(1,J) FOR L=12
L=10
DO 51 JD=lv40
J=41-JD
DO 51 ID=1940
1=41-ID
CALL TOTAL(IJKSTTOT)
CALL CON2CABCLDX(IhtDY(J),DB2,TOT)
PBY(1I J)=SX( I JK)-A*PBY( I+19J)
PBY(1.J)=(PBY(1,J)-C*PBX(IJ+l))/B
P5(1 ,J)=(*PBY(I,J)?+PBY( I+1,J) )/2.
51
PBX(IJ),=2**P5(IJ)-PBX(1,J+1)
CALL CKZ(P49P5)
C
PBX(I,1) FOR L=10 IS PBX(1,1) FOR L=7
DO 55 1=1940
55
F1(I)
